from cryptography.fernet import Fernet
import os
import sys

def carregar_chave():
    """Carrega a chave de descriptografia"""
    try:
        with open("chave.key", "rb") as f:
            return f.read()
    except FileNotFoundError:
        print("ERRO: Arquivo chave.key não encontrado!")
        print("Certifique-se de que a chave está no mesmo diretório")
        sys.exit(1)

def descriptografar_arquivo(arquivo, chave):
    """Descriptografa um arquivo individual"""
    try:
        f = Fernet(chave)
        with open(arquivo, "rb") as file:
            dados_criptografados = file.read()
        
        dados_descriptografados = f.decrypt(dados_criptografados)
        
        with open(arquivo, "wb") as file:
            file.write(dados_descriptografados)
        
        print(f"✓ {arquivo} - DESCRIPTOGRAFADO")
        return True
    except Exception as e:
        print(f"✗ {arquivo} - ERRO: {str(e)}")
        return False

def encontrar_arquivos(diretorio):
    """Encontra arquivos criptografados para descriptografar"""
    lista = []
    arquivos_protegidos = ["ransoware.py", "LEIA ISSO.txt", "chave.key", "descriptografar.py"]
    
    for raiz, _, arquivos in os.walk(diretorio):
        for nome in arquivos:
            caminho = os.path.join(raiz, nome)
            if nome not in arquivos_protegidos:
                lista.append(caminho)
    return lista

def main():
    """Função principal de descriptografia"""
    print("=== INICIANDO DESCRIPTOGRAFIA ===")
    
    # Verificar se a chave existe
    if not os.path.exists("chave.key"):
        print("ERRO: Arquivo 'chave.key' não encontrado!")
        print("Coloque o arquivo chave.key no mesmo diretório deste script")
        return
    
    # Carregar chave
    chave = carregar_chave()
    print("✓ Chave carregada com sucesso")
    
    # Encontrar arquivos para descriptografar
    arquivos = encontrar_arquivos(".")
    
    if not arquivos:
        print("Nenhum arquivo encontrado para descriptografar!")
        return
    
    print(f"Encontrados {len(arquivos)} arquivos para descriptografar...")
    
    # Descriptografar cada arquivo
    sucessos = 0
    for arquivo in arquivos:
        if descriptografar_arquivo(arquivo, chave):
            sucessos += 1
    
    print(f"\n=== DESCRIPTOGRAFIA CONCLUÍDA ===")
    print(f"Arquivos descriptografados com sucesso: {sucessos}/{len(arquivos)}")

if __name__ == "__main__":
    main()